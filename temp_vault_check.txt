import { useState, useEffect } from "react";
import { motion } from "framer-motion";
import { Link } from "react-router-dom";
import { ArrowLeft, Download, Upload, Wallet, RefreshCw, ExternalLink, Coins, Zap } from "lucide-react";
import Header from "@/components/Header";
import CryptoLogo from "@/components/CryptoLogo";
import WalletDebug from "@/components/WalletDebug";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { useWallet } from "@/contexts/WalletContext";
import { useVault } from "@/hooks/useVault";
import { useMarketData } from "@/hooks/useMarketData";
import { useSmartContractVault } from "@/hooks/useSmartContractVault";
import { balanceService } from "@/services/BalanceService";

const Vault = () => {
  const { account, connected } = useWallet();
  const { vault, balances, transactions, isLoading, error, refreshVault, deposit, withdraw, getFormattedBalance } = useVault();
  const { tokenPrices } = useMarketData();
  const { 
    isProcessing: contractProcessing, 
    error: contractError, 
    depositAPTtoVault, 
    depositTokenToVault,
    withdrawFromVault, 
    mintTestTokens,
    swapTokens,
    clearError: clearContractError 
  } = useSmartContractVault();
  
  const [selectedToken, setSelectedToken] = useState<"APT" | "USDC" | "USDT">("APT");
  const [depositAmount, setDepositAmount] = useState("");
  const [withdrawAmount, setWithdrawAmount] = useState("");
  const [mintAmount, setMintAmount] = useState("");
  const [swapAmount, setSwapAmount] = useState("");
  const [swapFromToken, setSwapFromToken] = useState<"USDC" | "USDT">("USDC");
  const [swapToToken, setSwapToToken] = useState<"USDC" | "USDT">("USDT");
  const [walletBalances, setWalletBalances] = useState<Record<string, string>>({});
  const [isProcessing, setIsProcessing] = useState(false);
  const [localError, setLocalError] = useState<string | null>(null);
  
  // Supported tokens with their configurations
  const supportedTokens: Array<{ symbol: "APT" | "USDC" | "USDT"; name: string }> = [
    { symbol: "APT", name: "Aptos" },
    { symbol: "USDC", name: "USD Coin" },
    { symbol: "USDT", name: "Tether USD" },
  ];

  // Load wallet balances with enhanced debugging
  useEffect(() => {
    const loadWalletBalances = async () => {
      if (!account?.address) return;
      
      try {
        
        // Test individual balance fetching
        const aptBalance = await balanceService.fetchAPTBalance(account.address);
        
        const usdcBalance = await balanceService.fetchUSDCBalance(account.address);
        
        const usdtBalance = await balanceService.fetchUSDTBalance(account.address);
        
        const allBalances = { APT: aptBalance, USDC: usdcBalance, USDT: usdtBalance };
        
        setWalletBalances(allBalances);
      } catch (err) {
        console.error('âŒ Failed to load wallet balances:', err);
        // Set empty balances on error to prevent UI issues
        setWalletBalances({ APT: '0', USDC: '0', USDT: '0' });
      }
    };

    if (connected && account?.address) {
      loadWalletBalances();
      // Also refresh balances every 30 seconds
      const interval = setInterval(loadWalletBalances, 30000);
      return () => clearInterval(interval);
    }
  }, [account?.address, connected]);

  // Get token data with real prices and vault balances
  const getTokenData = (symbol: "APT" | "USDC" | "USDT") => {
    const vaultBalance = getFormattedBalance(symbol);
    const walletBalance = walletBalances[symbol] || '0';
    const priceData = tokenPrices[symbol];
    
    // Calculate USD value using priceNum (numeric price from Coinbase API)
    const balance = parseFloat(vaultBalance) || 0;
    const price = priceData?.priceNum || 0;
    const usdValue = balance * price;
    
    return {
      symbol,
      balance: vaultBalance,
      walletBalance,
      usdValue: `$${usdValue.toFixed(2)}`,
      price: priceData ? `$${priceData.priceNum.toFixed(4)}` : '$0.00',
      change: priceData?.change || '0.0%',
      isPositive: priceData?.change?.startsWith('+') ?? true
    };
  };

  const tokens = supportedTokens.map(token => getTokenData(token.symbol));
  const selectedTokenData = tokens.find(t => t.symbol === selectedToken);

  // Handle deposit using smart contract
  const handleDeposit = async () => {
    if (!account?.address || !depositAmount || isProcessing || contractProcessing) return;
    
    setIsProcessing(true);
    clearContractError();
    setLocalError(null);
    
    try {
      if (selectedToken === 'APT') {
        // For
